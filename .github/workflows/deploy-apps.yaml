name: Deploy MAWDY Apps

on:
  push:
    branches: ["main"]
    paths:
      - "src/**"
      - ".github/workflows/**"
  workflow_dispatch:

# -----------------------------------------------------------------------------
# CONFIGURACIÓN (Rellena esto con los outputs de Terraform)
# -----------------------------------------------------------------------------
env:
  RESOURCE_GROUP: "rg-mawdy-lab-dev"
  ACR_LOGIN_SERVER: "acrmawdylabdevexoy.azurecr.io"
  # Nota: Usamos comillas dobles para evitar problemas con las barras
  ACA_ENV_ID: "/subscriptions/01a55008-9942-4e2a-83d8-e88e6f0f5c6c/resourceGroups/rg-mawdy-lab-dev/providers/Microsoft.App/managedEnvironments/aca-env-mawdy-lab-dev"
  SQL_SERVER_FQDN: "sql-mawdy-lab-dev-exoy.database.windows.net"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # 1. Login en Azure
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 2. Obtener credenciales de ACR dinámicamente
      - name: Get ACR Credentials
        id: acr-creds
        run: |
          USERNAME=$(az acr credential show --name ${{ env.ACR_LOGIN_SERVER }} --query username -o tsv)
          PASSWORD=$(az acr credential show --name ${{ env.ACR_LOGIN_SERVER }} --query passwords[0].value -o tsv)
          echo "::add-mask::$PASSWORD"
          echo "username=$USERNAME" >> $GITHUB_OUTPUT
          echo "password=$PASSWORD" >> $GITHUB_OUTPUT

      # 3. Login en Docker
      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ steps.acr-creds.outputs.username }}
          password: ${{ steps.acr-creds.outputs.password }}

      # 4. Construir y Subir BACKEND
      - name: Build & Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./src/backend-api
          push: true
          tags: ${{ env.ACR_LOGIN_SERVER }}/backend-api:${{ github.sha }}

      # 5. Construir y Subir FRONTEND
      - name: Build & Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./src/frontend-app
          push: true
          tags: ${{ env.ACR_LOGIN_SERVER }}/frontend-app:${{ github.sha }}

      # 6. Desplegar BACKEND (Modo Robust: Azure CLI)
      - name: Deploy Backend (via CLI)
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az extension add --name containerapp --upgrade

            echo "Desplegando Backend en entorno: ${{ env.ACA_ENV_ID }}"

            # Creamos la app inyectando la Connection String completa como secreto
            az containerapp create \
              --name backend-api \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --environment "${{ env.ACA_ENV_ID }}" \
              --image ${{ env.ACR_LOGIN_SERVER }}/backend-api:${{ github.sha }} \
              --target-port 8080 \
              --ingress internal \
              --min-replicas 1 --max-replicas 1 \
              --secrets "sql-conn-string=Server=tcp:${{ env.SQL_SERVER_FQDN }},1433;Initial Catalog=MawdyDB;Persist Security Info=False;User ID=sqladmin;Password=${{ secrets.SQL_PASSWORD }};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;" \
              --env-vars "SQL_CONNECTION_STRING=secretref:sql-conn-string"

      # 7. Obtener URL del Backend
      - name: Get Backend URL
        id: get-backend-url
        uses: azure/CLI@v1
        with:
          inlineScript: |
            BACKEND_FQDN=$(az containerapp show --name backend-api --resource-group ${{ env.RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn -o tsv)
            echo "backend_url=https://$BACKEND_FQDN" >> $GITHUB_OUTPUT
            echo "Backend detectado en: https://$BACKEND_FQDN"

      # 8. Desplegar FRONTEND (Modo Robust: Azure CLI)
      - name: Deploy Frontend (via CLI)
        uses: azure/CLI@v1
        with:
          inlineScript: |
            echo "Conectando Frontend a: ${{ steps.get-backend-url.outputs.backend_url }}"

            az containerapp create \
              --name frontend-app \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --environment "${{ env.ACA_ENV_ID }}" \
              --image ${{ env.ACR_LOGIN_SERVER }}/frontend-app:${{ github.sha }} \
              --target-port 80 \
              --ingress external \
              --min-replicas 1 --max-replicas 1 \
              --env-vars "API_BASE_URL=${{ steps.get-backend-url.outputs.backend_url }}"
